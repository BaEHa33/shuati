<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºåŠŸèƒ½è°ƒè¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-200;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-blue-600 active:bg-blue-700;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-slate-600 active:bg-slate-700;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-green-600 active:bg-green-700;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-red-600 active:bg-red-700;
            }
            .card {
                @apply bg-white rounded-xl shadow-lg p-6 border border-gray-200;
            }
            .log-entry {
                @apply mb-1 text-sm font-mono;
            }
            .log-info {
                @apply text-blue-600;
            }
            .log-success {
                @apply text-green-600;
            }
            .log-warning {
                @apply text-yellow-600;
            }
            .log-error {
                @apply text-red-600;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ” å¯¼å‡ºåŠŸèƒ½è°ƒè¯•</h1>
            <p class="text-gray-600">è¯Šæ–­å¯¼å‡ºåŒæ­¥æ•°æ®åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œçš„åŸå› </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- è¯Šæ–­æ§åˆ¶åŒº -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ› ï¸ è¯Šæ–­å·¥å…·</h2>
                <div class="space-y-4">
                    <button id="checkSyncModuleBtn" class="btn btn-primary w-full">
                        <i class="fa fa-check-circle mr-2"></i>æ£€æŸ¥åŒæ­¥æ¨¡å—
                    </button>
                    <button id="testDirectExportBtn" class="btn btn-success w-full">
                        <i class="fa fa-download mr-2"></i>æµ‹è¯•ç›´æ¥å¯¼å‡º
                    </button>
                    <button id="testSyncExportBtn" class="btn btn-secondary w-full">
                        <i class="fa fa-cloud-download mr-2"></i>æµ‹è¯•åŒæ­¥å¯¼å‡º
                    </button>
                    <button id="reloadScriptsBtn" class="btn btn-warning w-full">
                        <i class="fa fa-refresh mr-2"></i>é‡æ–°åŠ è½½è„šæœ¬
                    </button>
                    <button id="clearLogBtn" class="btn btn-danger w-full">
                        <i class="fa fa-trash mr-2"></i>æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">åŒæ­¥æ¨¡å—åŠ è½½:</span>
                        <span id="syncModuleStatus" class="text-lg font-bold text-red-600">âŒ æœªåŠ è½½</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">å¯¼å‡ºæ–¹æ³•å­˜åœ¨:</span>
                        <span id="exportMethodStatus" class="text-lg font-bold text-red-600">âŒ ä¸å­˜åœ¨</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">å½“å‰ç”¨æˆ·:</span>
                        <span id="currentUserStatus" class="text-lg font-bold text-yellow-600">âš ï¸ æœªç™»å½•</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">åº”ç”¨å®ä¾‹:</span>
                        <span id="appInstanceStatus" class="text-lg font-bold text-yellow-600">âš ï¸ æœªå°±ç»ª</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯åŒº -->
        <div class="mt-8 card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">CrossDeviceSync å¯¹è±¡:</h3>
                    <pre id="syncModuleInfo" class="bg-gray-50 p-3 rounded-lg text-sm font-mono overflow-x-auto">ç­‰å¾…æ£€æŸ¥...</pre>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">Window å¯¹è±¡å±æ€§:</h3>
                    <pre id="windowPropsInfo" class="bg-gray-50 p-3 rounded-lg text-sm font-mono overflow-x-auto max-h-40">ç­‰å¾…æ£€æŸ¥...</pre>
                </div>
            </div>
        </div>

        <!-- è¯Šæ–­æ—¥å¿— -->
        <div class="mt-8 card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ“ è¯Šæ–­æ—¥å¿—</h2>
                <span id="logCount" class="text-sm text-gray-600">0 æ¡æ—¥å¿—</span>
            </div>
            <div class="bg-gray-900 text-gray-300 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                <div id="logContainer"></div>
            </div>
        </div>
    </div>

    <!-- å…ˆåŠ è½½è·¨è®¾å¤‡åŒæ­¥è„šæœ¬ -->
    <script src="cross-device-sync.js"></script>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        class Logger {
            constructor() {
                this.logs = [];
                this.maxLogs = 200;
            }

            log(type, ...messages) {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const logEntry = {
                    type,
                    timestamp,
                    messages: messages.map(msg => 
                        typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg
                    )
                };
                
                this.logs.push(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }
                
                this.updateDisplay();
            }

            info(...messages) {
                this.log('info', ...messages);
            }

            success(...messages) {
                this.log('success', ...messages);
            }

            warning(...messages) {
                this.log('warning', ...messages);
            }

            error(...messages) {
                this.log('error', ...messages);
            }

            updateDisplay() {
                const logContainer = document.getElementById('logContainer');
                const logCount = document.getElementById('logCount');
                
                logCount.textContent = `${this.logs.length} æ¡æ—¥å¿—`;
                
                logContainer.innerHTML = this.logs.map(entry => {
                    const typeClass = `log-${entry.type}`;
                    const icon = {
                        info: 'â„¹ï¸',
                        success: 'âœ…',
                        warning: 'âš ï¸',
                        error: 'âŒ'
                    }[entry.type];
                    
                    return `
                        <div class="log-entry">
                            <span class="${typeClass}">[${entry.timestamp}] ${icon}</span>
                            ${entry.messages.join(' ')}
                        </div>
                    `;
                }).join('');
                
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            clear() {
                this.logs = [];
                this.updateDisplay();
            }
        }

        const logger = new Logger();

        // è¯Šæ–­å·¥å…·
        class DiagnosticTool {
            constructor() {
                this.logger = logger;
                this.initializeEventListeners();
                this.initialCheck();
            }

            initializeEventListeners() {
                document.getElementById('checkSyncModuleBtn').addEventListener('click', () => this.checkSyncModule());
                document.getElementById('testDirectExportBtn').addEventListener('click', () => this.testDirectExport());
                document.getElementById('testSyncExportBtn').addEventListener('click', () => this.testSyncExport());
                document.getElementById('reloadScriptsBtn').addEventListener('click', () => this.reloadScripts());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.logger.clear());
            }

            initialCheck() {
                this.logger.info('ğŸš€ è¯Šæ–­å·¥å…·åˆå§‹åŒ–å®Œæˆ');
                this.logger.info('ğŸ“‹ å¼€å§‹ç³»ç»ŸçŠ¶æ€æ£€æŸ¥...');
                
                setTimeout(() => {
                    this.checkSyncModule();
                }, 100);
            }

            checkSyncModule() {
                this.logger.info('ğŸ” æ£€æŸ¥åŒæ­¥æ¨¡å—çŠ¶æ€...');
                
                // æ£€æŸ¥ window.crossDeviceSync
                const syncModuleExists = !!window.crossDeviceSync;
                const syncModuleStatus = document.getElementById('syncModuleStatus');
                
                if (syncModuleExists) {
                    syncModuleStatus.textContent = 'âœ… å·²åŠ è½½';
                    syncModuleStatus.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… window.crossDeviceSync æ¨¡å—å·²åŠ è½½');
                } else {
                    syncModuleStatus.textContent = 'âŒ æœªåŠ è½½';
                    syncModuleStatus.className = 'text-lg font-bold text-red-600';
                    this.logger.error('âŒ window.crossDeviceSync æ¨¡å—æœªåŠ è½½');
                }
                
                // æ£€æŸ¥ exportSyncData æ–¹æ³•
                const exportMethodExists = syncModuleExists && typeof window.crossDeviceSync.exportSyncData === 'function';
                const exportMethodStatus = document.getElementById('exportMethodStatus');
                
                if (exportMethodExists) {
                    exportMethodStatus.textContent = 'âœ… å­˜åœ¨';
                    exportMethodStatus.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… exportSyncData æ–¹æ³•å­˜åœ¨ä¸”ä¸ºå‡½æ•°');
                } else {
                    exportMethodStatus.textContent = 'âŒ ä¸å­˜åœ¨';
                    exportMethodStatus.className = 'text-lg font-bold text-red-600';
                    this.logger.error('âŒ exportSyncData æ–¹æ³•ä¸å­˜åœ¨æˆ–ä¸æ˜¯å‡½æ•°');
                }
                
                // æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€
                const currentUser = window.app ? window.app.currentUser : null;
                const currentUserStatus = document.getElementById('currentUserStatus');
                
                if (currentUser) {
                    currentUserStatus.textContent = `âœ… ${currentUser.username}`;
                    currentUserStatus.className = 'text-lg font-bold text-green-600';
                    this.logger.success(`âœ… å½“å‰ç”¨æˆ·å·²ç™»å½•: ${currentUser.username}`);
                } else {
                    currentUserStatus.textContent = 'âš ï¸ æœªç™»å½•';
                    currentUserStatus.className = 'text-lg font-bold text-yellow-600';
                    this.logger.warning('âš ï¸ å½“å‰ç”¨æˆ·æœªç™»å½•');
                }
                
                // æ£€æŸ¥åº”ç”¨å®ä¾‹
                const appInstanceStatus = document.getElementById('appInstanceStatus');
                if (window.app) {
                    appInstanceStatus.textContent = 'âœ… å·²å°±ç»ª';
                    appInstanceStatus.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… window.app å®ä¾‹å·²å°±ç»ª');
                } else {
                    appInstanceStatus.textContent = 'âš ï¸ æœªå°±ç»ª';
                    appInstanceStatus.className = 'text-lg font-bold text-yellow-600';
                    this.logger.warning('âš ï¸ window.app å®ä¾‹æœªå°±ç»ª');
                }
                
                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                this.updateDetailedInfo();
                
                this.logger.info('ğŸ“‹ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ');
            }

            updateDetailedInfo() {
                // æ›´æ–°åŒæ­¥æ¨¡å—ä¿¡æ¯
                const syncModuleInfo = document.getElementById('syncModuleInfo');
                if (window.crossDeviceSync) {
                    const info = {
                        type: typeof window.crossDeviceSync,
                        hasExportMethod: typeof window.crossDeviceSync.exportSyncData === 'function',
                        hasImportMethod: typeof window.crossDeviceSync.importSyncData === 'function',
                        deviceId: window.crossDeviceSync.deviceId || 'undefined',
                        methods: Object.getOwnPropertyNames(window.crossDeviceSync.__proto__ || window.crossDeviceSync)
                            .filter(key => typeof window.crossDeviceSync[key] === 'function')
                    };
                    syncModuleInfo.textContent = JSON.stringify(info, null, 2);
                } else {
                    syncModuleInfo.textContent = 'window.crossDeviceSync ä¸å­˜åœ¨';
                }
                
                // æ›´æ–° window å¯¹è±¡å±æ€§
                const windowPropsInfo = document.getElementById('windowPropsInfo');
                const windowProps = Object.keys(window)
                    .filter(key => key.includes('sync') || key.includes('cross') || key.includes('app'))
                    .sort();
                
                windowPropsInfo.textContent = windowProps.map(key => `${key}: ${typeof window[key]}`).join('\n');
            }

            testDirectExport() {
                this.logger.info('ğŸ“¤ æµ‹è¯•ç›´æ¥å¯¼å‡ºåŠŸèƒ½...');
                
                try {
                    // æ¨¡æ‹Ÿå¯¼å‡ºæ•°æ®
                    const mockData = {
                        deviceId: 'test_device_' + Date.now(),
                        exportTime: new Date().toISOString(),
                        publicQuestions: [
                            {
                                id: 'test_pub_1',
                                content: 'æµ‹è¯•é¢˜ç›®1',
                                type: 'single',
                                options: ['é€‰é¡¹A', 'é€‰é¡¹B', 'é€‰é¡¹C', 'é€‰é¡¹D'],
                                answer: '1'
                            }
                        ],
                        personalQuestions: [
                            {
                                id: 'test_per_1',
                                content: 'æµ‹è¯•é¢˜ç›®2',
                                type: 'judge',
                                answer: 'true'
                            }
                        ],
                        syncCount: 2
                    };
                    
                    const dataStr = JSON.stringify(mockData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test_export_${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.logger.success('âœ… ç›´æ¥å¯¼å‡ºæµ‹è¯•æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½');
                } catch (error) {
                    this.logger.error('âŒ ç›´æ¥å¯¼å‡ºæµ‹è¯•å¤±è´¥:', error.message);
                }
            }

            testSyncExport() {
                this.logger.info('ğŸ”„ æµ‹è¯•åŒæ­¥æ¨¡å—å¯¼å‡ºåŠŸèƒ½...');
                
                if (!window.crossDeviceSync) {
                    this.logger.error('âŒ åŒæ­¥æ¨¡å—æœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•');
                    return;
                }
                
                if (typeof window.crossDeviceSync.exportSyncData !== 'function') {
                    this.logger.error('âŒ exportSyncData æ–¹æ³•ä¸å­˜åœ¨æˆ–ä¸æ˜¯å‡½æ•°');
                    return;
                }
                
                try {
                    this.logger.info('ğŸ“¤ è°ƒç”¨ window.crossDeviceSync.exportSyncData()...');
                    window.crossDeviceSync.exportSyncData();
                    this.logger.success('âœ… åŒæ­¥å¯¼å‡ºè°ƒç”¨æˆåŠŸï¼');
                } catch (error) {
                    this.logger.error('âŒ åŒæ­¥å¯¼å‡ºè°ƒç”¨å¤±è´¥:', error.message);
                    this.logger.error('âŒ é”™è¯¯è¯¦æƒ…:', error.stack);
                }
            }

            reloadScripts() {
                this.logger.info('ğŸ”„ é‡æ–°åŠ è½½è„šæœ¬...');
                
                // ç§»é™¤ç°æœ‰çš„åŒæ­¥æ¨¡å—
                if (window.crossDeviceSync) {
                    delete window.crossDeviceSync;
                    this.logger.warning('âš ï¸ å·²ç§»é™¤ç°æœ‰çš„åŒæ­¥æ¨¡å—');
                }
                
                // é‡æ–°åŠ è½½è„šæœ¬
                const script = document.createElement('script');
                script.src = 'cross-device-sync.js?v=' + Date.now();
                script.onload = () => {
                    this.logger.success('âœ… åŒæ­¥è„šæœ¬é‡æ–°åŠ è½½å®Œæˆ');
                    setTimeout(() => this.checkSyncModule(), 100);
                };
                script.onerror = () => {
                    this.logger.error('âŒ åŒæ­¥è„šæœ¬é‡æ–°åŠ è½½å¤±è´¥');
                };
                document.head.appendChild(script);
            }
        }

        // åˆå§‹åŒ–è¯Šæ–­å·¥å…·
        document.addEventListener('DOMContentLoaded', () => {
            const diagnosticTool = new DiagnosticTool();
            logger.info('ğŸ¯ è¯Šæ–­å·¥å…·å·²å¯åŠ¨');
        });

        // ç›‘å¬è„šæœ¬åŠ è½½é”™è¯¯
        window.addEventListener('error', (event) => {
            if (event.target.tagName === 'SCRIPT') {
                logger.error('âŒ è„šæœ¬åŠ è½½é”™è¯¯:', event.target.src, event.message);
            }
        });
    </script>
</body>
</html>