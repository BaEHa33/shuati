<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ - å¤šç”¨æˆ·åŒæ­¥ç‰ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07c160',
                        secondary: '#f5f5f5',
                        accent: '#ff6900',
                        danger: '#fa5151',
                        success: '#19be6b',
                        warning: '#ff9800',
                        info: '#00bcd4',
                        light: '#f8f9fa',
                        dark: '#343a40'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #07c160, #19be6b);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
        }
        
        .btn-secondary {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            border-color: #07c160;
            color: #07c160;
        }
        
        .nav-link {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #07c160;
        }
        
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #07c160, #19be6b);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e0e0e0;
                z-index: 1000;
            }
            
            body {
                padding-bottom: 70px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- ç™»å½•é¡µé¢ -->
        <div v-if="!currentUser" class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                <div class="text-center mb-8">
                    <div class="text-5xl mb-4">ğŸ“š</div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ</h1>
                    <p class="text-gray-600">å¤šç”¨æˆ·åŒæ­¥ç‰ˆ - è®©å­¦ä¹ æ›´é«˜æ•ˆ</p>
                </div>
                
                <div v-if="authMode === 'login'" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                        <input 
                            type="text" 
                            v-model="loginForm.username" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                            @keyup.enter="login"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                        <input 
                            type="password" 
                            v-model="loginForm.password" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            @keyup.enter="login"
                        >
                    </div>
                    <button 
                        @click="login" 
                        class="btn-primary w-full"
                        :disabled="loading"
                    >
                        {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                    </button>
                    <div class="text-center text-sm">
                        <span class="text-gray-600">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                        <button @click="authMode = 'register'" class="text-primary font-medium hover:underline">
                            ç«‹å³æ³¨å†Œ
                        </button>
                    </div>
                </div>
                
                <div v-else class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                        <input 
                            type="text" 
                            v-model="registerForm.username" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="è¯·è®¾ç½®ç”¨æˆ·å"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‚®ç®±</label>
                        <input 
                            type="email" 
                            v-model="registerForm.email" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="è¯·è¾“å…¥é‚®ç®±"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                        <input 
                            type="password" 
                            v-model="registerForm.password" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                            placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
                        >
                    </div>
                    <button 
                        @click="register" 
                        class="btn-primary w-full"
                        :disabled="loading"
                    >
                        {{ loading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ' }}
                    </button>
                    <div class="text-center text-sm">
                        <span class="text-gray-600">å·²æœ‰è´¦å·ï¼Ÿ</span>
                        <button @click="authMode = 'login'" class="text-primary font-medium hover:underline">
                            ç«‹å³ç™»å½•
                        </button>
                    </div>
                </div>
                
                <div v-if="errorMessage" class="mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm text-center">
                    {{ errorMessage }}
                </div>
                
                <div class="mt-8 text-center text-xs text-gray-500">
                    <p>ğŸ“ æµ‹è¯•è´¦å·ï¼šdemo / å¯†ç ï¼š123456</p>
                    <p class="mt-1">ğŸ‘¨â€ğŸ’» ç®¡ç†å‘˜è´¦å·ï¼šadmin / å¯†ç ï¼šadmin123</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»åº”ç”¨ -->
        <div v-else class="min-h-screen bg-gray-50">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <nav class="bg-white shadow-sm sticky top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <div class="text-2xl font-bold text-primary flex items-center">
                                ğŸ“š æ™ºèƒ½åˆ·é¢˜
                                <span v-if="currentUser && currentUser.role === 'admin'" class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ç®¡ç†å‘˜</span>
                            </div>
                        </div>
                        
                        <div class="hidden md:flex items-center space-x-8">
                            <div class="nav-link" :class="{active: currentMode === 'home'}" @click="switchMode('home')">
                                ğŸ  é¦–é¡µ
                            </div>
                            <div class="nav-link" :class="{active: currentMode === 'questions'}" @click="switchMode('questions')">
                                ğŸ“ é¢˜åº“ç®¡ç†
                            </div>
                            <div class="nav-link" :class="{active: currentMode === 'exam'}" @click="switchMode('exam')">
                                ğŸš€ è€ƒè¯•
                            </div>
                            <div class="nav-link" :class="{active: currentMode === 'mistakes'}" @click="switchMode('mistakes')">
                                âŒ é”™é¢˜æœ¬
                            </div>
                            <div class="nav-link" :class="{active: currentMode === 'stats'}" @click="switchMode('stats')">
                                ğŸ“Š ç»Ÿè®¡
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                {{ currentUser.username }}
                            </div>
                            <button @click="logout" class="text-sm text-red-600 hover:text-red-800">
                                é€€å‡º
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- é¦–é¡µ -->
                <div v-if="currentMode === 'home'" class="space-y-8">
                    <!-- æ¬¢è¿å¡ç‰‡ -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 text-white">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div>
                                <h1 class="text-3xl font-bold mb-2">æ¬¢è¿å›æ¥ï¼Œ{{ currentUser.username }}ï¼</h1>
                                <p class="text-blue-100">ç»§ç»­ä½ çš„å­¦ä¹ ä¹‹æ—…ï¼Œæå‡å­¦ä¹ æ•ˆç‡</p>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <button @click="switchMode('exam')" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-medium hover:bg-blue-50 transition-all">
                                    ğŸš€ å¼€å§‹è€ƒè¯•
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="text-4xl mb-4">ğŸ“š</div>
                            <div class="text-2xl font-bold text-gray-800 mb-2">{{ studyStats.totalQuestions || 0 }}</div>
                            <div class="text-gray-600">æ€»é¢˜æ•°</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="text-4xl mb-4">ğŸ¯</div>
                            <div class="text-2xl font-bold text-green-600 mb-2">{{ studyStats.correctRate || 0 }}%</div>
                            <div class="text-gray-600">æ­£ç¡®ç‡</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="text-4xl mb-4">â°</div>
                            <div class="text-2xl font-bold text-blue-600 mb-2">{{ formatStudyTime(studyStats.totalStudyTime || 0) }}</div>
                            <div class="text-gray-600">å­¦ä¹ æ—¶é•¿</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                            <div class="text-4xl mb-4">âŒ</div>
                            <div class="text-2xl font-bold text-red-600 mb-2">{{ mistakeCount || 0 }}</div>
                            <div class="text-gray-600">é”™é¢˜æ•°</div>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6 cursor-pointer card-hover" @click="switchMode('questions')">
                            <div class="flex items-center mb-4">
                                <div class="text-3xl mr-4">ğŸ“</div>
                                <h3 class="text-xl font-bold text-gray-800">é¢˜åº“ç®¡ç†</h3>
                            </div>
                            <p class="text-gray-600 mb-4">ç®¡ç†ä¸ªäººé¢˜åº“å’Œå…±äº«é¢˜åº“</p>
                            <div class="text-primary font-medium">æŸ¥çœ‹é¢˜åº“ â†’</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 cursor-pointer card-hover" @click="switchMode('mistakes')">
                            <div class="flex items-center mb-4">
                                <div class="text-3xl mr-4">âŒ</div>
                                <h3 class="text-xl font-bold text-gray-800">é”™é¢˜å¤ä¹ </h3>
                            </div>
                            <p class="text-gray-600 mb-4">é’ˆå¯¹æ€§å¤ä¹ é”™é¢˜ï¼Œæé«˜æ•ˆç‡</p>
                            <div class="text-primary font-medium">å¤ä¹ é”™é¢˜ â†’</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 cursor-pointer card-hover" @click="switchMode('stats')">
                            <div class="flex items-center mb-4">
                                <div class="text-3xl mr-4">ğŸ“Š</div>
                                <h3 class="text-xl font-bold text-gray-800">å­¦ä¹ ç»Ÿè®¡</h3>
                            </div>
                            <p class="text-gray-600 mb-4">æŸ¥çœ‹å­¦ä¹ è¿›åº¦å’Œæˆç»©è¶‹åŠ¿</p>
                            <div class="text-primary font-medium">æŸ¥çœ‹ç»Ÿè®¡ â†’</div>
                        </div>
                    </div>
                    
                    <!-- æœ€è¿‘è€ƒè¯•è®°å½• -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">æœ€è¿‘è€ƒè¯•è®°å½•</h3>
                        <div v-if="recentExams.length > 0" class="space-y-4">
                            <div v-for="(exam, index) in recentExams" :key="index" class="border rounded-lg p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-sm text-gray-600">{{ formatDate(exam.date) }}</div>
                                    <div :class="getScoreClass(exam.score)">{{ exam.score }}åˆ†</div>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <div>æ­£ç¡®: {{ exam.correctCount }} / æ€»é¢˜: {{ exam.totalQuestions }}</div>
                                    <div>ç”¨æ—¶: {{ formatDuration(exam.duration) }}</div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center text-gray-500 py-8">
                            æš‚æ— è€ƒè¯•è®°å½•
                        </div>
                    </div>
                </div>
                
                <!-- é¢˜åº“ç®¡ç† -->
                <div v-if="currentMode === 'questions'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">é¢˜åº“ç®¡ç†</h2>
                            <div class="flex space-x-3">
                                <button @click="showAddQuestionDialog = true" class="btn-primary">
                                    â• æ·»åŠ é¢˜ç›®
                                </button>
                                <select v-model="questionFilter.type" class="border rounded-lg px-3 py-2">
                                    <option value="">å…¨éƒ¨é¢˜å‹</option>
                                    <option value="single">å•é€‰é¢˜</option>
                                    <option value="multiple">å¤šé€‰é¢˜</option>
                                    <option value="judge">åˆ¤æ–­é¢˜</option>
                                    <option value="fill">å¡«ç©ºé¢˜</option>
                                    <option value="essay">ç®€ç­”é¢˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- æ ‡ç­¾é¡µ -->
                        <div class="border-b mb-6">
                            <div class="flex space-x-6">
                                <div 
                                    :class="['px-4 py-3 cursor-pointer font-medium', questionsTab === 'personal' ? 'border-b-2 border-primary text-primary' : 'text-gray-600']"
                                    @click="questionsTab = 'personal'"
                                >
                                    ä¸ªäººé¢˜åº“ ({{ personalQuestions.length }})
                                </div>
                                <div 
                                    :class="['px-4 py-3 cursor-pointer font-medium', questionsTab === 'public' ? 'border-b-2 border-primary text-primary' : 'text-gray-600']"
                                    @click="questionsTab = 'public'"
                                >
                                    å…±äº«é¢˜åº“ ({{ publicQuestions.length }})
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸ªäººé¢˜åº“ -->
                        <div v-if="questionsTab === 'personal'" class="space-y-4">
                            <div v-for="question in filteredPersonalQuestions" :key="question.id" class="border rounded-lg p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm mr-2">
                                            {{ getQuestionTypeText(question.type) }}
                                        </span>
                                        <span class="text-gray-500 text-sm">#{{ question.id.substring(0, 8) }}</span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button @click="editQuestion(question)" class="text-blue-600 text-sm">
                                            ç¼–è¾‘
                                        </button>
                                        <button @click="deletePersonalQuestion(question.id)" class="text-red-600 text-sm">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3 text-gray-800">{{ question.content }}</div>
                                <div class="text-sm text-gray-600">
                                    <div v-if="question.options && question.options.length">
                                        <strong>é€‰é¡¹:</strong> {{ question.options.length }} ä¸ª
                                    </div>
                                    <div v-if="question.analysis">
                                        <strong>è§£æ:</strong> {{ question.analysis.substring(0, 100) }}{{ question.analysis.length > 100 ? '...' : '' }}
                                    </div>
                                </div>
                            </div>
                            <div v-if="filteredPersonalQuestions.length === 0" class="text-center text-gray-500 py-8">
                                æš‚æ— ä¸ªäººé¢˜ç›®
                            </div>
                        </div>
                        
                        <!-- å…±äº«é¢˜åº“ -->
                        <div v-else class="space-y-4">
                            <div v-for="question in filteredPublicQuestions" :key="question.id" class="border rounded-lg p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">
                                            {{ getQuestionTypeText(question.type) }}
                                        </span>
                                        <span class="text-gray-500 text-sm">by {{ question.createdBy?.username || 'åŒ¿å' }}</span>
                                    </div>
                                    <button @click="addToPersonal(question)" class="text-green-600 text-sm">
                                        â• æ”¶è—
                                    </button>
                                </div>
                                <div class="mb-3 text-gray-800">{{ question.content }}</div>
                                <div class="text-sm text-gray-600">
                                    <div v-if="question.options && question.options.length">
                                        <strong>é€‰é¡¹:</strong> {{ question.options.length }} ä¸ª
                                    </div>
                                    <div v-if="question.analysis">
                                        <strong>è§£æ:</strong> {{ question.analysis.substring(0, 100) }}{{ question.analysis.length > 100 ? '...' : '' }}
                                    </div>
                                </div>
                            </div>
                            <div v-if="filteredPublicQuestions.length === 0" class="text-center text-gray-500 py-8">
                                æš‚æ— å…±äº«é¢˜ç›®
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è€ƒè¯•é¡µé¢ -->
                <div v-if="currentMode === 'exam'" class="space-y-6">
                    <!-- è€ƒè¯•é…ç½® -->
                    <div v-if="!isExamStarted" class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">è€ƒè¯•é…ç½®</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">è€ƒè¯•ç±»å‹</label>
                                    <select v-model="examConfig.rule" class="w-full border rounded-lg px-3 py-2">
                                        <option value="random">éšæœºæŠ½é¢˜</option>
                                        <option value="sequential">é¡ºåºå‡ºé¢˜</option>
                                        <option value="difficulty">æŒ‰éš¾åº¦å‡ºé¢˜</option>
                                    </select>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å•é€‰é¢˜</label>
                                        <input type="number" v-model.number="examConfig.single" min="0" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å¤šé€‰é¢˜</label>
                                        <input type="number" v-model.number="examConfig.multiple" min="0" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ¤æ–­é¢˜</label>
                                        <input type="number" v-model.number="examConfig.judge" min="0" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å¡«ç©ºé¢˜</label>
                                        <input type="number" v-model.number="examConfig.fill" min="0" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ç®€ç­”é¢˜</label>
                                        <input type="number" v-model.number="examConfig.essay" min="0" class="w-full border rounded-lg px-3 py-2">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">è€ƒè¯•æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                                    <input type="number" v-model.number="examConfig.time" min="1" class="w-full border rounded-lg px-3 py-2">
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" v-model="examConfig.enableTimer" id="enableTimer">
                                    <label for="enableTimer">å¯ç”¨è®¡æ—¶å™¨</label>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" v-model="examConfig.showAnswerImmediately" id="showAnswer">
                                    <label for="showAnswer">ç«‹å³æ˜¾ç¤ºç­”æ¡ˆ</label>
                                </div>
                            </div>
                            
                            <div>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                    <h4 class="text-green-700 font-semibold mb-2">ğŸ“ è€ƒè¯•é¢„è§ˆ</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>å•é€‰é¢˜ï¼š</span>
                                            <span class="font-medium">{{ examConfig.single }} é“</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>å¤šé€‰é¢˜ï¼š</span>
                                            <span class="font-medium">{{ examConfig.multiple }} é“</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>åˆ¤æ–­é¢˜ï¼š</span>
                                            <span class="font-medium">{{ examConfig.judge }} é“</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>å¡«ç©ºé¢˜ï¼š</span>
                                            <span class="font-medium">{{ examConfig.fill }} é“</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>ç®€ç­”é¢˜ï¼š</span>
                                            <span class="font-medium">{{ examConfig.essay }} é“</span>
                                        </div>
                                        <hr class="my-2">
                                        <div class="flex justify-between font-semibold">
                                            <span>æ€»è®¡ï¼š</span>
                                            <span>{{ totalExamQuestions }} é“</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <button class="btn-primary w-full" @click="startExam" :disabled="totalExamQuestions === 0">
                                        ğŸš€ å¼€å§‹è€ƒè¯•
                                    </button>
                                    <button class="btn-secondary w-full" @click="loadRecommendedConfig">
                                        ğŸ“‹ æ¨èé…ç½®
                                    </button>
                                    <button class="btn-secondary w-full" @click="resetConfig">
                                        ğŸ”„ é‡ç½®é…ç½®
                                    </button>
                                </div>
                                
                                <div v-if="totalExamQuestions === 0" class="mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm text-center">
                                    è¯·è‡³å°‘é€‰æ‹©ä¸€é“é¢˜ç›®ï¼
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è€ƒè¯•è¿›è¡Œä¸­ -->
                    <div v-else-if="isExamStarted && !isExamFinished" class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <!-- è€ƒè¯•å¤´éƒ¨ -->
                        <div class="bg-primary text-white p-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-xl font-bold mb-2">æ™ºèƒ½åˆ·é¢˜è€ƒè¯•</h2>
                                    <div class="text-sm opacity-90">
                                        ç¬¬ {{ currentQuestionIndex + 1 }} é¢˜ / å…± {{ currentQuestions.length }} é¢˜
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div v-if="examConfig.enableTimer" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                                        â° {{ formatTime(remainingTime) }}
                                    </div>
                                    <button @click="pauseExam" class="bg-white text-primary px-4 py-2 rounded-lg text-sm">
                                        â¸ï¸ æš‚åœ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é¢˜ç›®å†…å®¹ -->
                        <div class="p-6">
                            <div class="mb-6">
                                <div class="text-lg mb-6">{{ currentQuestion.content }}</div>
                                
                                <!-- å•é€‰é¢˜ -->
                                <div v-if="currentQuestion.type === 'single'" class="space-y-3">
                                    <div 
                                        v-for="(option, index) in currentQuestion.options" 
                                        :key="index"
                                        class="border rounded-lg p-4 cursor-pointer transition-all"
                                        :class="{
                                            'border-primary bg-primary bg-opacity-5': userAnswers[currentQuestionIndex] === index,
                                            'border-green-500 bg-green-50': currentAnswerSubmitted && index === currentQuestion.answer,
                                            'border-red-500 bg-red-50': currentAnswerSubmitted && userAnswers[currentQuestionIndex] === index && index !== currentQuestion.answer,
                                            'opacity-70 cursor-not-allowed': currentAnswerSubmitted
                                        }"
                                        @click="selectOption(index)"
                                    >
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 font-medium">
                                                {{ String.fromCharCode(65 + index) }}
                                            </div>
                                            <div>{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å¤šé€‰é¢˜ -->
                                <div v-if="currentQuestion.type === 'multiple'" class="space-y-3">
                                    <div 
                                        v-for="(option, index) in currentQuestion.options" 
                                        :key="index"
                                        class="border rounded-lg p-4 cursor-pointer transition-all"
                                        :class="{
                                            'border-primary bg-primary bg-opacity-5': userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].includes(index),
                                            'border-green-500 bg-green-50': currentAnswerSubmitted && currentQuestion.answer.includes(index),
                                            'border-red-500 bg-red-50': currentAnswerSubmitted && userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].includes(index) && !currentQuestion.answer.includes(index),
                                            'opacity-70 cursor-not-allowed': currentAnswerSubmitted
                                        }"
                                        @click="selectOption(index)"
                                    >
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 font-medium">
                                                {{ String.fromCharCode(65 + index) }}
                                            </div>
                                            <div>{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- åˆ¤æ–­é¢˜ -->
                                <div v-if="currentQuestion.type === 'judge'" class="space-y-3">
                                    <div 
                                        v-for="(option, index) in currentQuestion.options" 
                                        :key="index"
                                        class="border rounded-lg p-4 cursor-pointer transition-all"
                                        :class="{
                                            'border-primary bg-primary bg-opacity-5': userAnswers[currentQuestionIndex] === index,
                                            'border-green-500 bg-green-50': currentAnswerSubmitted && index === currentQuestion.answer,
                                            'border-red-500 bg-red-50': currentAnswerSubmitted && userAnswers[currentQuestionIndex] === index && index !== currentQuestion.answer,
                                            'opacity-70 cursor-not-allowed': currentAnswerSubmitted
                                        }"
                                        @click="selectOption(index)"
                                    >
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 font-medium">
                                                {{ String.fromCharCode(65 + index) }}
                                            </div>
                                            <div>{{ option }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å¡«ç©ºé¢˜ -->
                                <div v-if="currentQuestion.type === 'fill'" class="mb-6">
                                    <input 
                                        type="text" 
                                        v-model="userAnswers[currentQuestionIndex]"
                                        class="w-full border rounded-lg px-4 py-3"
                                        :disabled="currentAnswerSubmitted"
                                        placeholder="è¯·è¾“å…¥ç­”æ¡ˆ..."
                                    >
                                </div>
                                
                                <!-- ç®€ç­”é¢˜ -->
                                <div v-if="currentQuestion.type === 'essay'" class="mb-6">
                                    <textarea 
                                        v-model="userAnswers[currentQuestionIndex]"
                                        class="w-full border rounded-lg px-4 py-3"
                                        :disabled="currentAnswerSubmitted"
                                        placeholder="è¯·è¾“å…¥ç­”æ¡ˆ..."
                                        rows="5"
                                    ></textarea>
                                </div>
                                
                                <!-- ç­”æ¡ˆè§£æ -->
                                <div v-if="currentAnswerSubmitted" class="mt-6 p-4 rounded-lg" :class="isAnswerCorrect(currentQuestionIndex) ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                                    <div class="flex items-center mb-3">
                                        <div class="text-lg mr-2">ğŸ“</div>
                                        <h4 class="font-semibold">ç­”æ¡ˆè§£æ</h4>
                                    </div>
                                    <div class="mb-3">
                                        <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> {{ formatAnswer(currentQuestion.answer) }}
                                    </div>
                                    <div v-if="currentQuestion.analysis" class="text-sm text-gray-700">
                                        <strong>è§£æï¼š</strong> {{ currentQuestion.analysis }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex flex-wrap gap-3">
                                <button 
                                    class="btn-primary" 
                                    @click="submitCurrentAnswer"
                                    :disabled="currentAnswerSubmitted || !hasAnswerForCurrentQuestion"
                                >
                                    {{ currentAnswerSubmitted ? 'âœ“ å·²æäº¤' : 'ğŸ“¤ æäº¤ç­”æ¡ˆ' }}
                                </button>
                                <button 
                                    class="btn-secondary" 
                                    @click="nextQuestion"
                                >
                                    â¡ï¸ ä¸‹ä¸€é¢˜
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è€ƒè¯•ç»“æœ -->
                    <div v-else-if="isExamFinished" class="bg-white rounded-xl shadow-sm p-6 text-center">
                        <div class="mb-8">
                            <div class="text-6xl mb-4">ğŸ‰</div>
                            <div class="text-4xl font-bold text-primary mb-2">{{ examResult.score }}åˆ†</div>
                            <div class="text-xl font-semibold" :class="getGradeClass(examResult.grade)">{{ examResult.grade }}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="text-2xl font-bold mb-1">{{ examResult.totalQuestions }}</div>
                                <div class="text-sm text-gray-600">æ€»é¢˜æ•°</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 mb-1">{{ examResult.correctCount }}</div>
                                <div class="text-sm text-gray-600">æ­£ç¡®æ•°</div>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg">
                                <div class="text-2xl font-bold text-red-600 mb-1">{{ examResult.wrongCount }}</div>
                                <div class="text-sm text-gray-600">é”™è¯¯æ•°</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600 mb-1">{{ formatDuration(examResult.duration) }}</div>
                                <div class="text-sm text-gray-600">ç”¨æ—¶</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <button class="btn-primary" @click="reviewExam">
                                ğŸ“Š æŸ¥çœ‹è¯¦æƒ…
                            </button>
                            <button class="btn-secondary" @click="startNewExam">
                                ğŸ”„ é‡æ–°è€ƒè¯•
                            </button>
                            <button class="btn-secondary" @click="switchMode('home')">
                                ğŸ  è¿”å›é¦–é¡µ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- é”™é¢˜æœ¬ -->
                <div v-if="currentMode === 'mistakes'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">é”™é¢˜æœ¬</h2>
                            <div class="flex space-x-3">
                                <select v-model="mistakeFilter.type" class="border rounded-lg px-3 py-2">
                                    <option value="">å…¨éƒ¨é¢˜å‹</option>
                                    <option value="single">å•é€‰é¢˜</option>
                                    <option value="multiple">å¤šé€‰é¢˜</option>
                                    <option value="judge">åˆ¤æ–­é¢˜</option>
                                    <option value="fill">å¡«ç©ºé¢˜</option>
                                    <option value="essay">ç®€ç­”é¢˜</option>
                                </select>
                                <button @click="startMistakePractice" class="btn-primary">
                                    ğŸ“ é”™é¢˜ç»ƒä¹ 
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <div class="lg:col-span-1">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">æ—¶é—´èŒƒå›´</label>
                                        <select v-model="mistakeFilter.timeRange" class="w-full border rounded-lg px-3 py-2">
                                            <option value="">å…¨éƒ¨</option>
                                            <option value="today">ä»Šå¤©</option>
                                            <option value="week">æœ¬å‘¨</option>
                                            <option value="month">æœ¬æœˆ</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" v-model="mistakeFilter.importantOnly" id="importantOnly">
                                        <label for="importantOnly" class="ml-2 text-sm">åªçœ‹é‡ç‚¹é”™é¢˜</label>
                                    </div>
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-semibold mb-2">é”™é¢˜ç»Ÿè®¡</h4>
                                        <div class="space-y-1 text-sm">
                                            <div>æ€»é”™é¢˜ï¼š{{ mistakeBank.length }}</div>
                                            <div>é‡ç‚¹é”™é¢˜ï¼š{{ mistakeBank.filter(m => m.isImportant).length }}</div>
                                            <div>å·²å¤ä¹ ï¼š{{ mistakeBank.filter(m => m.reviewCount > 0).length }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-3">
                                <div class="space-y-4">
                                    <div v-for="mistake in filteredMistakes" :key="mistake.id" class="border rounded-lg p-4">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded text-sm mr-2">
                                                    {{ getQuestionTypeText(mistake.type) }}
                                                </span>
                                                <span class="text-gray-500 text-sm">{{ formatDate(mistake.mistakeTime) }}</span>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button @click="toggleImportant(mistake)" class="text-sm" :class="mistake.isImportant ? 'text-orange-600' : 'text-gray-400'">
                                                    {{ mistake.isImportant ? 'â­' : 'â˜†' }}
                                                </button>
                                                <button @click="removeMistake(mistake.id)" class="text-red-600 text-sm">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mb-3 text-gray-800">{{ mistake.content }}</div>
                                        <div class="text-sm text-gray-600 mb-3">
                                            <div><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> {{ formatAnswer(mistake.answer) }}</div>
                                            <div><strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong> {{ formatAnswer(mistake.wrongAnswer) }}</div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="reviewMistake(mistake)" class="btn-primary text-sm">
                                                é‡æ–°ç»ƒä¹ 
                                            </button>
                                            <button @click="markAsReviewed(mistake)" class="btn-secondary text-sm">
                                                æ ‡è®°å·²å¤ä¹ 
                                            </button>
                                        </div>
                                    </div>
                                    <div v-if="filteredMistakes.length === 0" class="text-center text-gray-500 py-8">
                                        æš‚æ— é”™é¢˜
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡é¡µé¢ -->
                <div v-if="currentMode === 'stats'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">å­¦ä¹ ç»Ÿè®¡</h2>
                        
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="p-6 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl">
                                <div class="text-4xl mb-4">ğŸ“Š</div>
                                <div class="text-2xl font-bold mb-2">{{ studyStats.examRecords?.length || 0 }}</div>
                                <div class="opacity-90">è€ƒè¯•æ¬¡æ•°</div>
                            </div>
                            <div class="p-6 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl">
                                <div class="text-4xl mb-4">ğŸ¯</div>
                                <div class="text-2xl font-bold mb-2">{{ studyStats.bestScore || 0 }}åˆ†</div>
                                <div class="opacity-90">æœ€é«˜åˆ†</div>
                            </div>
                            <div class="p-6 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl">
                                <div class="text-4xl mb-4">ğŸ“ˆ</div>
                                <div class="text-2xl font-bold mb-2">{{ studyStats.averageScore || 0 }}åˆ†</div>
                                <div class="opacity-90">å¹³å‡åˆ†</div>
                            </div>
                            <div class="p-6 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-xl">
                                <div class="text-4xl mb-4">â°</div>
                                <div class="text-2xl font-bold mb-2">{{ formatStudyTime(studyStats.totalStudyTime || 0) }}</div>
                                <div class="opacity-90">æ€»å­¦ä¹ æ—¶é•¿</div>
                            </div>
                        </div>
                        
                        <!-- æˆç»©è¶‹åŠ¿å›¾ -->
                        <div v-if="studyStats.examRecords && studyStats.examRecords.length > 1" class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">æˆç»©è¶‹åŠ¿</h3>
                            <div class="h-80">
                                <canvas id="scoreChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- è€ƒè¯•è®°å½• -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">è€ƒè¯•è®°å½•</h3>
                            <div v-if="studyStats.examRecords && studyStats.examRecords.length > 0" class="space-y-4">
                                <div v-for="(record, index) in studyStats.examRecords" :key="index" class="border rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-sm text-gray-600">{{ formatDate(record.date) }}</div>
                                        <div :class="getScoreClass(record.score)">{{ record.score }}åˆ†</div>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <div>æ­£ç¡®: {{ record.correctCount }} / æ€»é¢˜: {{ record.totalQuestions }}</div>
                                        <div>ç”¨æ—¶: {{ formatDuration(record.duration) }}</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-gray-500 py-8">
                                æš‚æ— è€ƒè¯•è®°å½•
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
            <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t z-40">
                <div class="flex justify-around py-2">
                    <button class="flex flex-col items-center p-2" :class="{active: currentMode === 'home'}" @click="switchMode('home')">
                        <span class="text-xl mb-1">ğŸ </span>
                        <span class="text-xs">é¦–é¡µ</span>
                    </button>
                    <button class="flex flex-col items-center p-2" :class="{active: currentMode === 'questions'}" @click="switchMode('questions')">
                        <span class="text-xl mb-1">ğŸ“</span>
                        <span class="text-xs">é¢˜åº“</span>
                    </button>
                    <button class="flex flex-col items-center p-2" :class="{active: currentMode === 'exam'}" @click="switchMode('exam')">
                        <span class="text-xl mb-1">ğŸš€</span>
                        <span class="text-xs">è€ƒè¯•</span>
                    </button>
                    <button class="flex flex-col items-center p-2" :class="{active: currentMode === 'mistakes'}" @click="switchMode('mistakes')">
                        <span class="text-xl mb-1">âŒ</span>
                        <span class="text-xs">é”™é¢˜</span>
                    </button>
                    <button class="flex flex-col items-center p-2" :class="{active: currentMode === 'stats'}" @click="switchMode('stats')">
                        <span class="text-xl mb-1">ğŸ“Š</span>
                        <span class="text-xs">ç»Ÿè®¡</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ·»åŠ é¢˜ç›®å¯¹è¯æ¡† -->
        <div v-if="showAddQuestionDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-6">æ·»åŠ é¢˜ç›®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢˜ç›®ç±»å‹</label>
                        <select v-model="newQuestion.type" class="w-full border rounded-lg px-3 py-2">
                            <option value="single">å•é€‰é¢˜</option>
                            <option value="multiple">å¤šé€‰é¢˜</option>
                            <option value="judge">åˆ¤æ–­é¢˜</option>
                            <option value="fill">å¡«ç©ºé¢˜</option>
                            <option value="essay">ç®€ç­”é¢˜</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢˜ç›®å†…å®¹</label>
                        <textarea v-model="newQuestion.content" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹..."></textarea>
                    </div>
                    
                    <!-- é€‰æ‹©é¢˜é€‰é¡¹ -->
                    <div v-if="['single', 'multiple', 'judge'].includes(newQuestion.type)" class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰é¡¹</label>
                        <div v-if="newQuestion.type === 'judge'" class="text-sm text-gray-600 mb-2">
                            åˆ¤æ–­é¢˜å°†è‡ªåŠ¨ä½¿ç”¨"æ­£ç¡®"å’Œ"é”™è¯¯"ä½œä¸ºé€‰é¡¹
                        </div>
                        <div v-if="newQuestion.type !== 'judge'" class="space-y-2">
                            <div v-for="(option, index) in newQuestion.options" :key="index" class="flex items-center space-x-2">
                                <span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-200 text-sm font-medium">
                                    {{ String.fromCharCode(65 + index) }}
                                </span>
                                <input type="text" v-model="newQuestion.options[index]" class="flex-1 border rounded-lg px-3 py-2" placeholder="è¯·è¾“å…¥é€‰é¡¹å†…å®¹...">
                                <button @click="removeOption(index)" class="text-red-600" :disabled="newQuestion.options.length <= 2">âœ•</button>
                            </div>
                            <button @click="addOption" class="text-sm text-primary">+ æ·»åŠ é€‰é¡¹</button>
                        </div>
                    </div>
                    
                    <!-- ç­”æ¡ˆ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ­£ç¡®ç­”æ¡ˆ</label>
                        <div v-if="newQuestion.type === 'single'">
                            <select v-model="newQuestion.answer" class="w-full border rounded-lg px-3 py-2">
                                <option value="" disabled>è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</option>
                                <option v-for="(option, index) in newQuestion.options" :key="index" :value="index">
                                    {{ String.fromCharCode(65 + index) }}. {{ option }}
                                </option>
                            </select>
                        </div>
                        <div v-else-if="newQuestion.type === 'multiple'">
                            <div class="space-y-2">
                                <div v-for="(option, index) in newQuestion.options" :key="index" class="flex items-center">
                                    <input type="checkbox" :value="index" v-model="newQuestion.answer" class="mr-2">
                                    <span>{{ String.fromCharCode(65 + index) }}. {{ option }}</span>
                                </div>
                            </div>
                        </div>
                        <div v-else-if="newQuestion.type === 'judge'">
                            <select v-model="newQuestion.answer" class="w-full border rounded-lg px-3 py-2">
                                <option value="" disabled>è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</option>
                                <option value="0">æ­£ç¡®</option>
                                <option value="1">é”™è¯¯</option>
                            </select>
                        </div>
                        <div v-else>
                            <input type="text" v-model="newQuestion.answer" class="w-full border rounded-lg px-3 py-2" placeholder="è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ...">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è§£æ</label>
                        <textarea v-model="newQuestion.analysis" class="w-full border rounded-lg px-3 py-2" rows="3" placeholder="è¯·è¾“å…¥é¢˜ç›®è§£æ..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showAddQuestionDialog = false" class="btn-secondary">
                        å–æ¶ˆ
                    </button>
                    <button @click="addQuestion" class="btn-primary">
                        æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æš‚åœè€ƒè¯•å¯¹è¯æ¡† -->
        <div v-if="showPauseDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md text-center">
                <div class="text-4xl mb-4">â¸ï¸</div>
                <h3 class="text-xl font-bold mb-2">è€ƒè¯•å·²æš‚åœ</h3>
                <p class="text-gray-600 mb-6">æ‚¨çš„è€ƒè¯•è¿›åº¦å·²ä¿å­˜ï¼Œå¯ä»¥éšæ—¶ç»§ç»­</p>
                <div class="space-y-3">
                    <button @click="resumeExam" class="btn-primary w-full">
                        â–¶ï¸ ç»§ç»­è€ƒè¯•
                    </button>
                    <button @click="submitExam" class="btn-secondary w-full">
                        ğŸ“¤ æäº¤è€ƒè¯•
                    </button>
                    <button @click="abandonExam" class="text-red-600 border border-red-600 px-4 py-2 rounded-lg w-full">
                        âŒ æ”¾å¼ƒè€ƒè¯•
                    </button>
                </div>
            </div>
        </div>
        
        <!-- è€ƒè¯•è¯¦æƒ…å¯¹è¯æ¡† -->
        <div v-if="showExamDetailDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">ğŸ“Š è€ƒè¯•è¯¦æƒ…</h3>
                    <button @click="showExamDetailDialog = false" class="text-gray-500 hover:text-gray-700">
                        âœ•
                    </button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg text-center">
                        <div class="text-2xl font-bold mb-1">{{ examResult.score }}</div>
                        <div class="text-sm text-gray-600">å¾—åˆ†</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg text-center">
                        <div class="text-2xl font-bold" :class="getGradeClass(examResult.grade)">{{ examResult.grade }}</div>
                        <div class="text-sm text-gray-600">ç­‰çº§</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600 mb-1">{{ examResult.correctCount }}</div>
                        <div class="text-sm text-gray-600">æ­£ç¡®æ•°</div>
                    </div>
                    <div class="p-4 bg-red-50 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600 mb-1">{{ examResult.wrongCount }}</div>
                        <div class="text-sm text-gray-600">é”™è¯¯æ•°</div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div v-for="(question, index) in currentQuestions" :key="index" class="border rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center mr-3 font-medium">
                                {{ index + 1 }}
                            </div>
                            <div class="text-sm font-medium">{{ getQuestionTypeText(question.type) }}</div>
                            <div class="ml-auto">
                                <span :class="isAnswerCorrect(index) ? 'text-green-600' : 'text-red-600'">
                                    {{ isAnswerCorrect(index) ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯' }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-3 text-gray-800">{{ question.content }}</div>
                        
                        <div class="text-sm text-gray-600">
                            <div><strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong> {{ formatAnswer(userAnswers[index]) }}</div>
                            <div v-if="!isAnswerCorrect(index)"><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> {{ formatAnswer(question.answer) }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center mt-6">
                    <button @click="showExamDetailDialog = false" class="btn-primary">
                        å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // å·¥å…·å‡½æ•°
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}åˆ†${secs}ç§’`;
        }
        
        function formatStudyTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
            }
            return `${mins}åˆ†é’Ÿ`;
        }
        
        function getQuestionTypeText(type) {
            const typeMap = {
                'single': 'å•é€‰é¢˜',
                'multiple': 'å¤šé€‰é¢˜',
                'judge': 'åˆ¤æ–­é¢˜',
                'fill': 'å¡«ç©ºé¢˜',
                'essay': 'ç®€ç­”é¢˜'
            };
            return typeMap[type] || 'æœªçŸ¥é¢˜å‹';
        }
        
        function formatAnswer(answer) {
            if (Array.isArray(answer)) {
                return answer.map(i => String.fromCharCode(65 + i)).join(', ');
            } else if (typeof answer === 'number') {
                return String.fromCharCode(65 + answer);
            } else if (answer === null || answer === undefined) {
                return 'æœªä½œç­”';
            } else {
                return answer;
            }
        }
        
        function getScoreClass(score) {
            if (score >= 90) return 'text-green-600 font-medium';
            if (score >= 80) return 'text-blue-600 font-medium';
            if (score >= 60) return 'text-orange-600 font-medium';
            return 'text-red-600 font-medium';
        }
        
        function getGradeClass(grade) {
            const gradeMap = {
                'ä¼˜ç§€': 'text-green-600',
                'è‰¯å¥½': 'text-blue-600',
                'åŠæ ¼': 'text-orange-600',
                'ä¸åŠæ ¼': 'text-red-600'
            };
            return gradeMap[grade] || 'text-gray-600';
        }
        
        // ä¸»åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            const app = {
                currentUser: null,
                authMode: 'login',
                loading: false,
                errorMessage: '',
                currentMode: 'home',
                token: localStorage.getItem('token'),
                
                // ç™»å½•è¡¨å•
                loginForm: {
                    username: '',
                    password: ''
                },
                
                // æ³¨å†Œè¡¨å•
                registerForm: {
                    username: '',
                    email: '',
                    password: ''
                },
                
                // é¢˜åº“ç®¡ç†
                questionsTab: 'personal',
                personalQuestions: [],
                publicQuestions: [],
                questionFilter: {
                    type: ''
                },
                
                // æ·»åŠ é¢˜ç›®
                showAddQuestionDialog: false,
                newQuestion: {
                    type: 'single',
                    content: '',
                    options: ['', ''],
                    answer: '',
                    analysis: ''
                },
                
                // é”™é¢˜æœ¬
                mistakeBank: [],
                mistakeFilter: {
                    type: '',
                    timeRange: '',
                    importantOnly: false
                },
                
                // å­¦ä¹ ç»Ÿè®¡
                studyStats: {
                    totalQuestions: 0,
                    correctAnswers: 0,
                    totalStudyTime: 0,
                    examRecords: [],
                    correctRate: 0,
                    averageScore: 0,
                    bestScore: 0
                },
                
                // è€ƒè¯•åŠŸèƒ½
                examConfig: {
                    single: 5,
                    multiple: 3,
                    judge: 5,
                    fill: 2,
                    essay: 1,
                    time: 60,
                    rule: 'random',
                    enableTimer: true,
                    showAnswerImmediately: true,
                    showAnalysis: true
                },
                isExamStarted: false,
                isExamFinished: false,
                currentQuestions: [],
                currentQuestionIndex: 0,
                userAnswers: {},
                currentAnswerSubmitted: false,
                examStartTime: null,
                remainingTime: 0,
                examTimer: null,
                showPauseDialog: false,
                showExamDetailDialog: false,
                examResult: {},
                
                // åˆå§‹åŒ–
                async init() {
                    // å°è¯•è‡ªåŠ¨ç™»å½•
                    if (this.token) {
                        await this.loadUserData();
                    }
                    
                    // æ¸²æŸ“é¡µé¢
                    this.render();
                    
                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();
                },
                
                // æ¸²æŸ“é¡µé¢
                render() {
                    // è¿™é‡Œä½¿ç”¨ç®€å•çš„DOMæ“ä½œï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨Vueã€Reactç­‰æ¡†æ¶
                    console.log('é¡µé¢å·²æ¸²æŸ“');
                },
                
                // ç»‘å®šäº‹ä»¶
                bindEvents() {
                    // è¿™é‡Œå¯ä»¥ç»‘å®šå…¨å±€äº‹ä»¶
                    console.log('äº‹ä»¶å·²ç»‘å®š');
                },
                
                // åŠ è½½ç”¨æˆ·æ•°æ®
                async loadUserData() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/user`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.currentUser = data.user;
                            await this.loadStudyData();
                        } else {
                            this.token = null;
                            localStorage.removeItem('token');
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                        this.token = null;
                        localStorage.removeItem('token');
                    }
                },
                
                // åŠ è½½å­¦ä¹ æ•°æ®
                async loadStudyData() {
                    try {
                        // åŠ è½½ä¸ªäººé¢˜åº“
                        const questionsResponse = await fetch(`${API_BASE_URL}/questions/personal`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        if (questionsResponse.ok) {
                            const data = await questionsResponse.json();
                            this.personalQuestions = data.data || [];
                        }
                        
                        // åŠ è½½å…±äº«é¢˜åº“
                        const publicResponse = await fetch(`${API_BASE_URL}/questions/public`);
                        if (publicResponse.ok) {
                            const data = await publicResponse.json();
                            this.publicQuestions = data.data || [];
                        }
                        
                        // åŠ è½½é”™é¢˜æœ¬
                        const mistakesResponse = await fetch(`${API_BASE_URL}/mistakes`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        if (mistakesResponse.ok) {
                            const data = await mistakesResponse.json();
                            this.mistakeBank = data.data || [];
                        }
                        
                        // åŠ è½½å­¦ä¹ ç»Ÿè®¡
                        const statsResponse = await fetch(`${API_BASE_URL}/stats`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        if (statsResponse.ok) {
                            const data = await statsResponse.json();
                            this.studyStats = data.data || this.studyStats;
                        }
                        
                        // æ¸²æŸ“ç»Ÿè®¡å›¾è¡¨
                        this.renderCharts();
                        
                    } catch (error) {
                        console.error('åŠ è½½å­¦ä¹ æ•°æ®å¤±è´¥:', error);
                    }
                },
                
                // ç™»å½•
                async login() {
                    this.loading = true;
                    this.errorMessage = '';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.loginForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.token = data.token;
                            localStorage.setItem('token', this.token);
                            this.currentUser = data.user;
                            await this.loadStudyData();
                            this.currentMode = 'home';
                        } else {
                            this.errorMessage = data.message || 'ç™»å½•å¤±è´¥';
                        }
                    } catch (error) {
                        this.errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                    } finally {
                        this.loading = false;
                    }
                },
                
                // æ³¨å†Œ
                async register() {
                    this.loading = true;
                    this.errorMessage = '';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.registerForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.token = data.token;
                            localStorage.setItem('token', this.token);
                            this.currentUser = data.user;
                            await this.loadStudyData();
                            this.currentMode = 'home';
                        } else {
                            this.errorMessage = data.message || 'æ³¨å†Œå¤±è´¥';
                        }
                    } catch (error) {
                        this.errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                    } finally {
                        this.loading = false;
                    }
                },
                
                // é€€å‡ºç™»å½•
                logout() {
                    this.currentUser = null;
                    this.token = null;
                    localStorage.removeItem('token');
                    this.authMode = 'login';
                    this.currentMode = 'home';
                    
                    // æ¸…ç©ºæ•°æ®
                    this.personalQuestions = [];
                    this.publicQuestions = [];
                    this.mistakeBank = [];
                    this.studyStats = {
                        totalQuestions: 0,
                        correctAnswers: 0,
                        totalStudyTime: 0,
                        examRecords: [],
                        correctRate: 0,
                        averageScore: 0,
                        bestScore: 0
                    };
                },
                
                // åˆ‡æ¢æ¨¡å¼
                switchMode(mode) {
                    this.currentMode = mode;
                    
                    // å¦‚æœåˆ‡æ¢åˆ°ç»Ÿè®¡é¡µé¢ï¼Œé‡æ–°æ¸²æŸ“å›¾è¡¨
                    if (mode === 'stats') {
                        setTimeout(() => this.renderCharts(), 100);
                    }
                },
                
                // æ·»åŠ é€‰é¡¹
                addOption() {
                    if (this.newQuestion.options.length < 10) {
                        this.newQuestion.options.push('');
                    }
                },
                
                // åˆ é™¤é€‰é¡¹
                removeOption(index) {
                    if (this.newQuestion.options.length > 2) {
                        this.newQuestion.options.splice(index, 1);
                    }
                },
                
                // æ·»åŠ é¢˜ç›®
                async addQuestion() {
                    if (!this.newQuestion.content || this.newQuestion.answer === '' || this.newQuestion.answer === null) {
                        alert('è¯·å¡«å†™å¿…è¦çš„é¢˜ç›®ä¿¡æ¯');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/questions/personal`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(this.newQuestion)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.personalQuestions.push(data.data);
                            this.showAddQuestionDialog = false;
                            
                            // é‡ç½®è¡¨å•
                            this.newQuestion = {
                                type: 'single',
                                content: '',
                                options: ['', ''],
                                answer: '',
                                analysis: ''
                            };
                            
                            alert('é¢˜ç›®æ·»åŠ æˆåŠŸ');
                        } else {
                            alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } catch (error) {
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    }
                },
                
                // åˆ é™¤ä¸ªäººé¢˜ç›®
                async deletePersonalQuestion(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/questions/personal/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        if (response.ok) {
                            this.personalQuestions = this.personalQuestions.filter(q => q.id !== id);
                            alert('åˆ é™¤æˆåŠŸ');
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } catch (error) {
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    }
                },
                
                // æ·»åŠ åˆ°ä¸ªäººé¢˜åº“
                async addToPersonal(question) {
                    try {
                        const personalQuestion = {
                            type: question.type,
                            content: question.content,
                            options: question.options || [],
                            answer: question.answer,
                            analysis: question.analysis || ''
                        };
                        
                        const response = await fetch(`${API_BASE_URL}/questions/personal`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(personalQuestion)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.personalQuestions.push(data.data);
                            alert('å·²æ·»åŠ åˆ°ä¸ªäººé¢˜åº“');
                        } else {
                            alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } catch (error) {
                        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    }
                },
                
                // åˆ‡æ¢é‡ç‚¹æ ‡è®°
                async toggleImportant(mistake) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/mistakes/${mistake.id}/important`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        if (response.ok) {
                            mistake.isImportant = !mistake.isImportant;
                        }
                    } catch (error) {
                        console.error('æ ‡è®°é‡ç‚¹é”™é¢˜å¤±è´¥:', error);
                    }
                },
                
                // åˆ é™¤é”™é¢˜
                async removeMistake(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é”™é¢˜å—ï¼Ÿ')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/mistakes/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        if (response.ok) {
                            this.mistakeBank = this.mistakeBank.filter(m => m.id !== id);
                        }
                    } catch (error) {
                        console.error('åˆ é™¤é”™é¢˜å¤±è´¥:', error);
                    }
                },
                
                // å¼€å§‹è€ƒè¯•
                startExam() {
                    const totalQuestions = this.examConfig.single + this.examConfig.multiple + 
                                          this.examConfig.judge + this.examConfig.fill + this.examConfig.essay;
                    
                    if (totalQuestions === 0) {
                        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é“é¢˜ç›®ï¼');
                        return;
                    }
                    
                    // ä»ä¸ªäººé¢˜åº“å’Œå…±äº«é¢˜åº“ä¸­é€‰æ‹©é¢˜ç›®
                    let allQuestions = [...this.personalQuestions];
                    
                    // æ ¹æ®é…ç½®ç­›é€‰é¢˜ç›®
                    let selectedQuestions = [];
                    
                    // å•é€‰é¢˜
                    if (this.examConfig.single > 0) {
                        const singleQuestions = allQuestions.filter(q => q.type === 'single');
                        selectedQuestions.push(...this.selectRandomQuestions(singleQuestions, this.examConfig.single));
                    }
                    
                    // å¤šé€‰é¢˜
                    if (this.examConfig.multiple > 0) {
                        const multipleQuestions = allQuestions.filter(q => q.type === 'multiple');
                        selectedQuestions.push(...this.selectRandomQuestions(multipleQuestions, this.examConfig.multiple));
                    }
                    
                    // åˆ¤æ–­é¢˜
                    if (this.examConfig.judge > 0) {
                        const judgeQuestions = allQuestions.filter(q => q.type === 'judge');
                        selectedQuestions.push(...this.selectRandomQuestions(judgeQuestions, this.examConfig.judge));
                    }
                    
                    // å¡«ç©ºé¢˜
                    if (this.examConfig.fill > 0) {
                        const fillQuestions = allQuestions.filter(q => q.type === 'fill');
                        selectedQuestions.push(...this.selectRandomQuestions(fillQuestions, this.examConfig.fill));
                    }
                    
                    // ç®€ç­”é¢˜
                    if (this.examConfig.essay > 0) {
                        const essayQuestions = allQuestions.filter(q => q.type === 'essay');
                        selectedQuestions.push(...this.selectRandomQuestions(essayQuestions, this.examConfig.essay));
                    }
                    
                    // æ‰“ä¹±é¢˜ç›®é¡ºåº
                    selectedQuestions = this.shuffleArray(selectedQuestions);
                    
                    this.currentQuestions = selectedQuestions;
                    this.currentQuestionIndex = 0;
                    this.userAnswers = {};
                    this.currentAnswerSubmitted = false;
                    this.isExamStarted = true;
                    this.isExamFinished = false;
                    this.examStartTime = Date.now();
                    this.remainingTime = this.examConfig.time * 60;
                    
                    // å¯åŠ¨è®¡æ—¶å™¨
                    if (this.examConfig.enableTimer) {
                        this.startTimer();
                    }
                },
                
                // é€‰æ‹©éšæœºé¢˜ç›®
                selectRandomQuestions(questions, count) {
                    const shuffled = this.shuffleArray([...questions]);
                    return shuffled.slice(0, Math.min(count, shuffled.length));
                },
                
                // æ‰“ä¹±æ•°ç»„
                shuffleArray(array) {
                    const shuffled = [...array];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    return shuffled;
                },
                
                // å¯åŠ¨è®¡æ—¶å™¨
                startTimer() {
                    if (this.examTimer) {
                        clearInterval(this.examTimer);
                    }
                    
                    this.examTimer = setInterval(() => {
                        if (this.remainingTime > 0) {
                            this.remainingTime--;
                        } else {
                            this.submitExam();
                        }
                    }, 1000);
                },
                
                // é€‰æ‹©é€‰é¡¹
                selectOption(index) {
                    if (this.currentAnswerSubmitted) return;
                    
                    const question = this.currentQuestions[this.currentQuestionIndex];
                    
                    if (question.type === 'multiple') {
                        if (!this.userAnswers[this.currentQuestionIndex]) {
                            this.userAnswers[this.currentQuestionIndex] = [];
                        }
                        const answers = this.userAnswers[this.currentQuestionIndex];
                        const optionIndex = answers.indexOf(index);
                        if (optionIndex > -1) {
                            answers.splice(optionIndex, 1);
                        } else {
                            answers.push(index);
                        }
                    } else {
                        this.userAnswers[this.currentQuestionIndex] = index;
                    }
                },
                
                // æäº¤å½“å‰ç­”æ¡ˆ
                submitCurrentAnswer() {
                    const question = this.currentQuestions[this.currentQuestionIndex];
                    const answer = this.userAnswers[this.currentQuestionIndex];
                    
                    if (answer === undefined || answer === null || answer === '') {
                        alert('è¯·å…ˆé€‰æ‹©ç­”æ¡ˆï¼');
                        return;
                    }
                    
                    this.currentAnswerSubmitted = true;
                    
                    // å¦‚æœç­”é”™äº†ï¼Œæ·»åŠ åˆ°é”™é¢˜æœ¬
                    if (!this.isAnswerCorrect(this.currentQuestionIndex)) {
                        this.addToMistakeBank(question, answer);
                    }
                },
                
                // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
                isAnswerCorrect(questionIndex) {
                    const question = this.currentQuestions[questionIndex];
                    const userAnswer = this.userAnswers[questionIndex];
                    
                    if (userAnswer === undefined) return false;
                    
                    if (question.type === 'multiple') {
                        if (!Array.isArray(userAnswer) || !Array.isArray(question.answer)) return false;
                        return JSON.stringify(userAnswer.sort()) === JSON.stringify(question.answer.sort());
                    } else if (question.type === 'fill') {
                        return userAnswer.toLowerCase().trim() === question.answer.toLowerCase().trim();
                    } else if (question.type === 'essay') {
                        // ç®€ç­”é¢˜ç®€å•åˆ¤æ–­
                        return userAnswer.length > 0;
                    } else {
                        return userAnswer === question.answer;
                    }
                },
                
                // æ·»åŠ åˆ°é”™é¢˜æœ¬
                async addToMistakeBank(question, wrongAnswer) {
                    try {
                        const mistake = {
                            questionId: question.id,
                            content: question.content,
                            type: question.type,
                            options: question.options || [],
                            answer: question.answer,
                            wrongAnswer: wrongAnswer,
                            analysis: question.analysis || ''
                        };
                        
                        const response = await fetch(`${API_BASE_URL}/mistakes`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(mistake)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.mistakeBank.push(data.data);
                        }
                    } catch (error) {
                        console.error('æ·»åŠ é”™é¢˜å¤±è´¥:', error);
                    }
                },
                
                // ä¸‹ä¸€é¢˜
                nextQuestion() {
                    if (this.currentQuestionIndex < this.currentQuestions.length - 1) {
                        this.currentQuestionIndex++;
                        this.currentAnswerSubmitted = false;
                    } else {
                        // æœ€åä¸€é¢˜ï¼Œæç¤ºæäº¤
                        if (confirm('å·²ç»æ˜¯æœ€åä¸€é¢˜ï¼Œæ˜¯å¦æäº¤è€ƒè¯•ï¼Ÿ')) {
                            this.submitExam();
                        }
                    }
                },
                
                // æš‚åœè€ƒè¯•
                pauseExam() {
                    if (this.examTimer) {
                        clearInterval(this.examTimer);
                    }
                    this.showPauseDialog = true;
                },
                
                // ç»§ç»­è€ƒè¯•
                resumeExam() {
                    this.showPauseDialog = false;
                    if (this.examConfig.enableTimer) {
                        this.startTimer();
                    }
                },
                
                // æäº¤è€ƒè¯•
                async submitExam() {
                    if (this.examTimer) {
                        clearInterval(this.examTimer);
                    }
                    
                    // è®¡ç®—æˆç»©
                    const totalQuestions = this.currentQuestions.length;
                    let correctCount = 0;
                    
                    for (let i = 0; i < totalQuestions; i++) {
                        if (this.isAnswerCorrect(i)) {
                            correctCount++;
                        }
                    }
                    
                    const score = Math.round((correctCount / totalQuestions) * 100);
                    
                    // è®¡ç®—ç­‰çº§
                    let grade = '';
                    if (score >= 90) grade = 'ä¼˜ç§€';
                    else if (score >= 80) grade = 'è‰¯å¥½';
                    else if (score >= 60) grade = 'åŠæ ¼';
                    else grade = 'ä¸åŠæ ¼';
                    
                    const duration = Math.round((Date.now() - this.examStartTime) / 1000);
                    
                    this.examResult = {
                        score,
                        grade,
                        totalQuestions,
                        correctCount,
                        wrongCount: totalQuestions - correctCount,
                        duration
                    };
                    
                    // ä¿å­˜è€ƒè¯•è®°å½•
                    await this.saveExamRecord(this.examResult);
                    
                    this.isExamFinished = true;
                    this.isExamStarted = false;
                    this.showPauseDialog = false;
                },
                
                // ä¿å­˜è€ƒè¯•è®°å½•
                async saveExamRecord(result) {
                    try {
                        const examRecord = {
                            score: result.score,
                            grade: result.grade,
                            correctCount: result.correctCount,
                            wrongCount: result.wrongCount,
                            totalQuestions: result.totalQuestions,
                            duration: result.duration,
                            questions: this.currentQuestions.map((q, i) => ({
                                content: q.content,
                                type: q.type,
                                isCorrect: this.isAnswerCorrect(i)
                            }))
                        };
                        
                        const response = await fetch(`${API_BASE_URL}/stats/exam`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(examRecord)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // æ›´æ–°å­¦ä¹ ç»Ÿè®¡
                            this.studyStats = data.data.updatedStats;
                        }
                    } catch (error) {
                        console.error('ä¿å­˜è€ƒè¯•è®°å½•å¤±è´¥:', error);
                    }
                },
                
                // æŸ¥çœ‹è€ƒè¯•è¯¦æƒ…
                reviewExam() {
                    this.showExamDetailDialog = true;
                },
                
                // é‡æ–°è€ƒè¯•
                startNewExam() {
                    this.isExamStarted = false;
                    this.isExamFinished = false;
                    this.currentQuestions = [];
                    this.userAnswers = {};
                },
                
                // æ”¾å¼ƒè€ƒè¯•
                abandonExam() {
                    if (this.examTimer) {
                        clearInterval(this.examTimer);
                    }
                    
                    this.isExamStarted = false;
                    this.isExamFinished = false;
                    this.showPauseDialog = false;
                    this.currentQuestions = [];
                    this.userAnswers = {};
                },
                
                // æ¸²æŸ“å›¾è¡¨
                renderCharts() {
                    const ctx = document.getElementById('scoreChart');
                    if (!ctx || !this.studyStats.examRecords || this.studyStats.examRecords.length <= 1) {
                        return;
                    }
                    
                    const records = this.studyStats.examRecords.slice(-10);
                    const labels = records.map(r => formatDate(r.date));
                    const scores = records.map(r => r.score);
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'è€ƒè¯•æˆç»©',
                                data: scores,
                                borderColor: '#07c160',
                                backgroundColor: 'rgba(7, 193, 96, 0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 10
                                    }
                                }
                            }
                        }
                    });
                },
                
                // åŠ è½½æ¨èé…ç½®
                loadRecommendedConfig() {
                    this.examConfig = {
                        single: 5,
                        multiple: 3,
                        judge: 5,
                        fill: 2,
                        essay: 1,
                        time: 60,
                        rule: 'random',
                        enableTimer: true,
                        showAnswerImmediately: true,
                        showAnalysis: true
                    };
                },
                
                // é‡ç½®é…ç½®
                resetConfig() {
                    this.examConfig = {
                        single: 0,
                        multiple: 0,
                        judge: 0,
                        fill: 0,
                        essay: 0,
                        time: 60,
                        rule: 'random',
                        enableTimer: true,
                        showAnswerImmediately: true,
                        showAnalysis: true
                    };
                },
                
                // å¼€å§‹é”™é¢˜ç»ƒä¹ 
                startMistakePractice() {
                    if (this.mistakeBank.length === 0) {
                        alert('é”™é¢˜æœ¬ä¸ºç©ºï¼');
                        return;
                    }
                    
                    // é€‰æ‹©é”™é¢˜
                    const practiceMistakes = this.shuffleArray([...this.mistakeBank]).slice(0, 10);
                    
                    this.currentQuestions = practiceMistakes;
                    this.currentQuestionIndex = 0;
                    this.userAnswers = {};
                    this.currentAnswerSubmitted = false;
                    this.isExamStarted = true;
                    this.isExamFinished = false;
                    this.examStartTime = Date.now();
                    this.remainingTime = 30 * 60; // 30åˆ†é’Ÿ
                    
                    // å¯åŠ¨è®¡æ—¶å™¨
                    this.startTimer();
                },
                
                // å¤ä¹ é”™é¢˜
                reviewMistake(mistake) {
                    this.currentQuestions = [mistake];
                    this.currentQuestionIndex = 0;
                    this.userAnswers = {};
                    this.currentAnswerSubmitted = false;
                    this.isExamStarted = true;
                    this.isExamFinished = false;
                    this.examStartTime = Date.now();
                    this.remainingTime = 0;
                },
                
                // æ ‡è®°å·²å¤ä¹ 
                async markAsReviewed(mistake) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/mistakes/${mistake.id}/review`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ isCorrect: true })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.data.removed) {
                                this.mistakeBank = this.mistakeBank.filter(m => m.id !== mistake.id);
                                alert('æ­å–œï¼è¿™é“é¢˜å·²ç»æŒæ¡ï¼Œå·²ä»é”™é¢˜æœ¬ä¸­ç§»é™¤');
                            } else {
                                mistake.reviewCount = data.data.reviewCount;
                                mistake.lastReviewTime = data.data.lastReviewTime;
                                alert('å¤ä¹ è®°å½•å·²æ›´æ–°');
                            }
                        }
                    } catch (error) {
                        console.error('æ ‡è®°å¤ä¹ å¤±è´¥:', error);
                    }
                },
                
                // è®¡ç®—å±æ€§
                get totalExamQuestions() {
                    return this.examConfig.single + this.examConfig.multiple + 
                           this.examConfig.judge + this.examConfig.fill + this.examConfig.essay;
                },
                
                get currentQuestion() {
                    return this.currentQuestions[this.currentQuestionIndex] || {};
                },
                
                get filteredPersonalQuestions() {
                    let questions = this.personalQuestions;
                    if (this.questionFilter.type) {
                        questions = questions.filter(q => q.type === this.questionFilter.type);
                    }
                    return questions;
                },
                
                get filteredPublicQuestions() {
                    let questions = this.publicQuestions;
                    if (this.questionFilter.type) {
                        questions = questions.filter(q => q.type === this.questionFilter.type);
                    }
                    return questions;
                },
                
                get filteredMistakes() {
                    let mistakes = this.mistakeBank;
                    
                    if (this.mistakeFilter.type) {
                        mistakes = mistakes.filter(m => m.type === this.mistakeFilter.type);
                    }
                    
                    if (this.mistakeFilter.importantOnly) {
                        mistakes = mistakes.filter(m => m.isImportant);
                    }
                    
                    if (this.mistakeFilter.timeRange) {
                        const now = new Date();
                        const filterDate = new Date();
                        
                        switch (this.mistakeFilter.timeRange) {
                            case 'today':
                                filterDate.setDate(now.getDate() - 1);
                                break;
                            case 'week':
                                filterDate.setDate(now.getDate() - 7);
                                break;
                            case 'month':
                                filterDate.setMonth(now.getMonth() - 1);
                                break;
                        }
                        
                        mistakes = mistakes.filter(m => new Date(m.mistakeTime) >= filterDate);
                    }
                    
                    return mistakes;
                },
                
                get mistakeCount() {
                    return this.mistakeBank.length;
                },
                
                get recentExams() {
                    return (this.studyStats.examRecords || []).slice(-5).reverse();
                }
            };
            
            // åˆå§‹åŒ–åº”ç”¨
            app.init();
            
            // å°†appæŒ‚è½½åˆ°windowå¯¹è±¡ï¼Œæ–¹ä¾¿è°ƒè¯•
            window.app = app;
            
            // ç®€å•çš„åŒå‘ç»‘å®š
            function updateUI() {
                // è¿™é‡Œå¯ä»¥æ·»åŠ ç®€å•çš„DOMæ›´æ–°é€»è¾‘
                setTimeout(updateUI, 100);
            }
            updateUI();
        });
    </script>
</body>
</html>