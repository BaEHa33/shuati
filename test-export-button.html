<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºæŒ‰é’®ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-200;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-blue-600 active:bg-blue-700;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-slate-600 active:bg-slate-700;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-green-600 active:bg-green-700;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-red-600 active:bg-red-700;
            }
            .card {
                @apply bg-white rounded-xl shadow-lg p-6 border border-gray-200;
            }
            .log-entry {
                @apply mb-1 text-sm font-mono;
            }
            .log-info {
                @apply text-blue-600;
            }
            .log-success {
                @apply text-green-600;
            }
            .log-warning {
                @apply text-yellow-600;
            }
            .log-error {
                @apply text-red-600;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ”§ å¯¼å‡ºæŒ‰é’®ä¿®å¤æµ‹è¯•</h1>
            <p class="text-gray-600">æµ‹è¯•å¯¼å‡ºåŒæ­¥æ•°æ®æŒ‰é’®çš„åŠŸèƒ½ï¼Œè¯Šæ–­é—®é¢˜åŸå› </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- æµ‹è¯•åŒºåŸŸ -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ¯ åŠŸèƒ½æµ‹è¯•</h2>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">ä¿®å¤åçš„å¯¼å‡ºæŒ‰é’®</h3>
                        <button class="btn-secondary w-full py-3" onclick="window.app.exportSyncData()">
                            ğŸ“¤ å¯¼å‡ºåŒæ­¥æ•°æ®
                        </button>
                        <p class="text-xs text-gray-500 mt-2">ä½¿ç”¨ onclick="window.app.exportSyncData()"</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">ç›´æ¥è°ƒç”¨æµ‹è¯•</h3>
                        <button id="directCallBtn" class="btn-primary w-full py-3">
                            ğŸš€ ç›´æ¥è°ƒç”¨å¯¼å‡ºå‡½æ•°
                        </button>
                        <p class="text-xs text-gray-500 mt-2">ç›´æ¥è°ƒç”¨ window.app.exportSyncData()</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-3">çŠ¶æ€æ£€æŸ¥</h3>
                        <button id="checkStatusBtn" class="btn-success w-full py-3">
                            ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
                        </button>
                        <p class="text-xs text-gray-500 mt-2">æ£€æŸ¥ window.app å’Œç›¸å…³æ–¹æ³•</p>
                    </div>
                </div>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">window.app å­˜åœ¨:</span>
                        <span id="appExists" class="text-lg font-bold text-red-600">âŒ ä¸å­˜åœ¨</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">exportSyncData æ–¹æ³•:</span>
                        <span id="exportMethod" class="text-lg font-bold text-red-600">âŒ ä¸å­˜åœ¨</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">å½“å‰ç”¨æˆ·:</span>
                        <span id="currentUser" class="text-lg font-bold text-yellow-600">âš ï¸ æœªç™»å½•</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">è·¨è®¾å¤‡æ¨¡å—:</span>
                        <span id="syncModule" class="text-lg font-bold text-yellow-600">âš ï¸ æœªæ£€æŸ¥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯ -->
        <div class="mt-8 card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">window.app å¯¹è±¡:</h3>
                    <pre id="appInfo" class="bg-gray-50 p-3 rounded-lg text-sm font-mono overflow-x-auto max-h-40">ç­‰å¾…æ£€æŸ¥...</pre>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">å¯ç”¨æ–¹æ³•:</h3>
                    <pre id="methodsInfo" class="bg-gray-50 p-3 rounded-lg text-sm font-mono overflow-x-auto max-h-40">ç­‰å¾…æ£€æŸ¥...</pre>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="mt-8 card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ“ æ“ä½œæ—¥å¿—</h2>
                <button id="clearLogBtn" class="btn btn-sm btn-danger">
                    <i class="fa fa-trash mr-1"></i>æ¸…ç©º
                </button>
            </div>
            <div class="bg-gray-900 text-gray-300 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                <div id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        class Logger {
            constructor() {
                this.logs = [];
                this.maxLogs = 100;
            }

            log(type, ...messages) {
                const timestamp = new Date().toLocaleTimeString('zh-CN');
                const logEntry = {
                    type,
                    timestamp,
                    messages: messages.map(msg => 
                        typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg
                    )
                };
                
                this.logs.push(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }
                
                this.updateDisplay();
            }

            info(...messages) {
                this.log('info', ...messages);
            }

            success(...messages) {
                this.log('success', ...messages);
            }

            warning(...messages) {
                this.log('warning', ...messages);
            }

            error(...messages) {
                this.log('error', ...messages);
            }

            updateDisplay() {
                const logContainer = document.getElementById('logContainer');
                
                logContainer.innerHTML = this.logs.map(entry => {
                    const typeClass = `log-${entry.type}`;
                    const icon = {
                        info: 'â„¹ï¸',
                        success: 'âœ…',
                        warning: 'âš ï¸',
                        error: 'âŒ'
                    }[entry.type];
                    
                    return `
                        <div class="log-entry">
                            <span class="${typeClass}">[${entry.timestamp}] ${icon}</span>
                            ${entry.messages.join(' ')}
                        </div>
                    `;
                }).join('');
                
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            clear() {
                this.logs = [];
                this.updateDisplay();
            }
        }

        const logger = new Logger();

        // æµ‹è¯•å·¥å…·
        class ExportTester {
            constructor() {
                this.logger = logger;
                this.initializeEventListeners();
                this.initialCheck();
            }

            initializeEventListeners() {
                // ç›´æ¥è°ƒç”¨æµ‹è¯•æŒ‰é’®
                document.getElementById('directCallBtn').addEventListener('click', () => {
                    this.testDirectExport();
                });

                // çŠ¶æ€æ£€æŸ¥æŒ‰é’®
                document.getElementById('checkStatusBtn').addEventListener('click', () => {
                    this.checkSystemStatus();
                });

                // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
                document.getElementById('clearLogBtn').addEventListener('click', () => {
                    this.logger.clear();
                    this.logger.info('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º');
                });
            }

            initialCheck() {
                this.logger.info('ğŸš€ å¯¼å‡ºæŒ‰é’®æµ‹è¯•å·¥å…·åˆå§‹åŒ–');
                this.logger.info('ğŸ” å¼€å§‹åˆå§‹çŠ¶æ€æ£€æŸ¥...');
                
                setTimeout(() => {
                    this.checkSystemStatus();
                }, 500);
            }

            checkSystemStatus() {
                this.logger.info('ğŸ“Š æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
                
                // æ£€æŸ¥ window.app
                const appExists = !!window.app;
                const appExistsEl = document.getElementById('appExists');
                
                if (appExists) {
                    appExistsEl.textContent = 'âœ… å­˜åœ¨';
                    appExistsEl.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… window.app å¯¹è±¡å­˜åœ¨');
                } else {
                    appExistsEl.textContent = 'âŒ ä¸å­˜åœ¨';
                    appExistsEl.className = 'text-lg font-bold text-red-600';
                    this.logger.error('âŒ window.app å¯¹è±¡ä¸å­˜åœ¨');
                }
                
                // æ£€æŸ¥ exportSyncData æ–¹æ³•
                const exportMethodExists = appExists && typeof window.app.exportSyncData === 'function';
                const exportMethodEl = document.getElementById('exportMethod');
                
                if (exportMethodExists) {
                    exportMethodEl.textContent = 'âœ… å­˜åœ¨';
                    exportMethodEl.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… exportSyncData æ–¹æ³•å­˜åœ¨ä¸”ä¸ºå‡½æ•°');
                } else {
                    exportMethodEl.textContent = 'âŒ ä¸å­˜åœ¨';
                    exportMethodEl.className = 'text-lg font-bold text-red-600';
                    this.logger.error('âŒ exportSyncData æ–¹æ³•ä¸å­˜åœ¨æˆ–ä¸æ˜¯å‡½æ•°');
                }
                
                // æ£€æŸ¥å½“å‰ç”¨æˆ·
                const currentUserEl = document.getElementById('currentUser');
                if (appExists && window.app.currentUser) {
                    currentUserEl.textContent = `âœ… ${window.app.currentUser.username}`;
                    currentUserEl.className = 'text-lg font-bold text-green-600';
                    this.logger.success(`âœ… å½“å‰ç”¨æˆ·å·²ç™»å½•: ${window.app.currentUser.username}`);
                } else {
                    currentUserEl.textContent = 'âš ï¸ æœªç™»å½•';
                    currentUserEl.className = 'text-lg font-bold text-yellow-600';
                    this.logger.warning('âš ï¸ å½“å‰ç”¨æˆ·æœªç™»å½•');
                }
                
                // æ£€æŸ¥è·¨è®¾å¤‡åŒæ­¥æ¨¡å—
                const syncModuleEl = document.getElementById('syncModule');
                if (window.crossDeviceSync) {
                    syncModuleEl.textContent = 'âœ… å·²åŠ è½½';
                    syncModuleEl.className = 'text-lg font-bold text-green-600';
                    this.logger.success('âœ… è·¨è®¾å¤‡åŒæ­¥æ¨¡å—å·²åŠ è½½');
                } else {
                    syncModuleEl.textContent = 'âŒ æœªåŠ è½½';
                    syncModuleEl.className = 'text-lg font-bold text-red-600';
                    this.logger.warning('âš ï¸ è·¨è®¾å¤‡åŒæ­¥æ¨¡å—æœªåŠ è½½');
                }
                
                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                this.updateDetailedInfo();
                
                this.logger.info('ğŸ“‹ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ');
            }

            updateDetailedInfo() {
                // æ›´æ–° app ä¿¡æ¯
                const appInfoEl = document.getElementById('appInfo');
                if (window.app) {
                    const appInfo = {
                        type: typeof window.app,
                        hasExportSyncData: typeof window.app.exportSyncData === 'function',
                        hasExportData: typeof window.app.exportData === 'function',
                        currentUser: window.app.currentUser ? window.app.currentUser.username : 'null',
                        hasPublicQuestions: Array.isArray(window.app.publicQuestionBank),
                        hasPersonalQuestions: Array.isArray(window.app.personalQuestionBank)
                    };
                    appInfoEl.textContent = JSON.stringify(appInfo, null, 2);
                } else {
                    appInfoEl.textContent = 'window.app ä¸å­˜åœ¨';
                }
                
                // æ›´æ–°æ–¹æ³•ä¿¡æ¯
                const methodsInfoEl = document.getElementById('methodsInfo');
                if (window.app) {
                    const methods = Object.getOwnPropertyNames(window.app)
                        .filter(key => typeof window.app[key] === 'function')
                        .sort();
                    methodsInfoEl.textContent = methods.join('\n');
                } else {
                    methodsInfoEl.textContent = 'æ— å¯ç”¨æ–¹æ³•';
                }
            }

            testDirectExport() {
                this.logger.info('ğŸ“¤ å¼€å§‹æµ‹è¯•å¯¼å‡ºåŒæ­¥æ•°æ®åŠŸèƒ½...');
                
                if (!window.app) {
                    this.logger.error('âŒ window.app å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æµ‹è¯•');
                    alert('é”™è¯¯ï¼šåº”ç”¨æœªåˆå§‹åŒ–ï¼');
                    return;
                }
                
                if (typeof window.app.exportSyncData !== 'function') {
                    this.logger.error('âŒ exportSyncData æ–¹æ³•ä¸å­˜åœ¨æˆ–ä¸æ˜¯å‡½æ•°');
                    alert('é”™è¯¯ï¼šå¯¼å‡ºæ–¹æ³•ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                try {
                    this.logger.info('ğŸš€ ç›´æ¥è°ƒç”¨ window.app.exportSyncData()...');
                    window.app.exportSyncData();
                    this.logger.success('âœ… å¯¼å‡ºåŒæ­¥æ•°æ®æˆåŠŸï¼');
                } catch (error) {
                    this.logger.error('âŒ å¯¼å‡ºåŒæ­¥æ•°æ®å¤±è´¥:', error.message);
                    this.logger.error('âŒ é”™è¯¯è¯¦æƒ…:', error.stack);
                    alert(`å¯¼å‡ºå¤±è´¥ï¼\né”™è¯¯: ${error.message}`);
                }
            }
        }

        // åˆå§‹åŒ–æµ‹è¯•å·¥å…·
        document.addEventListener('DOMContentLoaded', () => {
            const tester = new ExportTester();
            logger.info('ğŸ¯ æµ‹è¯•å·¥å…·å·²å¯åŠ¨');
        });

        // ç›‘å¬é”™è¯¯
        window.addEventListener('error', (event) => {
            logger.error('âŒ å…¨å±€é”™è¯¯:', event.message, event.filename, event.lineno);
        });

        window.addEventListener('unhandledrejection', (event) => {
            logger.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
        });
    </script>
</body>
</html>